FROM golang:1.18-alpine AS base
WORKDIR /app

ENV GO111MODULE="on"
ENV GOOS="linux"
ENV CGO_ENABLED=0

# System dependencies
RUN apk update \
    && apk add --no-cache \
    ca-certificates \
    git \
    && update-ca-certificates

### Development with hot reload and debugger
FROM base AS dev

WORKDIR /app

RUN go install github.com/cosmtrek/air@latest && go install github.com/go-delve/delve/cmd/dlv@latest

COPY go.mod /app/go.mod
RUN go mod download && go mod verify

COPY . /app

EXPOSE 3000
EXPOSE 2345

RUN go build -gcflags "all=-N -l" -o server -a .
CMD ["dlv", "--listen=:2345", "--headless=true", "--api-version=2", "--accept-multiclient", "exec", "./server"]
### Executable builder
#FROM base AS builder
#WORKDIR /app

# Application dependencies
#RUN go mod download \
#    && go mod verify

#RUN go build -gcflags "all=-N -l" -o server -a .
#
#ENTRYPOINT ["/usr/local/bin/server"]